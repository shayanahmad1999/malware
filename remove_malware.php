<?php
include 'connection.php';
$query = "SELECT * FROM `" . $table_name ."` WHERE `post_content` LIKE '%<script%'";
$fetch = $connect->query($query);

if ($fetch == false) {
    die($connect->error);
}

if ($fetch && $fetch->num_rows > 0) {
    $affected_rows = 0;

    foreach ($fetch as $value) {
        $post_content = $value['post_content'];

        $dom = new DOMDocument();
        libxml_use_internal_errors(true);
        $dom->loadHTML($post_content);
        libxml_clear_errors();

        $xpath = new DOMXPath($dom);
        $script_tags = $xpath->query('//script');

        foreach ($script_tags as $script_tag) {
            $script_tag->parentNode->removeChild($script_tag);
        }

        $cleaned_content = $dom->saveHTML();

        // $update_query = "UPDATE `wzcax_posts` SET `post_content` = '$cleaned_content' WHERE `post_content` LIKE '%<script%'";
        $update_query = "UPDATE `" . $table_name . "` SET `post_content` = '" . addslashes($cleaned_content) . "', post_modified = '" . $value['post_modified'] . "', post_modified_gmt = '" . $value['post_modified_gmt'] . "', post_modified = '" . $value['post_modified'] . "' WHERE `ID` = '" . $value['ID'] . "'";

        $connect->query($update_query) || die($connect->error);

        if ($connect->affected_rows > 0) $affected_rows += $connect->affected_rows;
    }

    echo "Malware removed and database updated. Number of rows affected: $affected_rows.";
} else {
    echo "No posts with malware found.";
}

$connect->close();
